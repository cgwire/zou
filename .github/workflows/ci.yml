---
name: Zou CI

on:
  push:
    branches: [main]
    tags: ["*"]
  pull_request:

jobs:
  ci:
    name: Test with Python 3.12 / PG 18 ðŸ
    runs-on: ubuntu-latest
    env:
      INDEXER_KEY: testkey0123456789
      PGPASSWORD: mysecretpassword
    services:
      postgres:
        image: "postgres:18"
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
        env:
          POSTGRES_PASSWORD: ${{ env.PGPASSWORD }}
      meilisearch:
        image: getmeili/meilisearch:v1.1
        ports:
          - 7700:7700
        env:
          MEILI_MASTER_KEY: ${{ env.INDEXER_KEY }}
    steps:
      - uses: actions/checkout@v6
      - name: Cache APT packages
        uses: actions/cache@v4
        id: apt-cache
        with:
          path: ~/apt-cache
          key: apt-ffmpeg-${{ runner.os }}
      - name: Install ffmpeg
        run: |
          if [ -d ~/apt-cache ] && ls ~/apt-cache/*.deb 1>/dev/null 2>&1; then
            sudo dpkg -i ~/apt-cache/*.deb 2>/dev/null || (sudo apt-get update -qq && sudo apt-get install -y -f --no-install-recommends)
          else
            sudo apt-get update -qq
            sudo apt-get install -y --no-install-recommends ffmpeg
            sudo apt-get autoclean -y
            mkdir -p ~/apt-cache
            cp /var/cache/apt/archives/ffmpeg*.deb ~/apt-cache/ 2>/dev/null || true
            cp /var/cache/apt/archives/libav*.deb ~/apt-cache/ 2>/dev/null || true
            cp /var/cache/apt/archives/libsw*.deb ~/apt-cache/ 2>/dev/null || true
            cp /var/cache/apt/archives/libpostproc*.deb ~/apt-cache/ 2>/dev/null || true
          fi
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          cache: pip
      - name: Upgrade pip ðŸ“¦
        run: >-
          pip install --upgrade pip setuptools
      - name: Install packages ðŸ“¦
        run: >-
          pip install -r requirements.txt
      - name: Create database ðŸ—„
        run: >-
          psql -c 'create database zoudb;' -U postgres -h 127.0.0.1
      - name: Run tests ðŸ§ª
        run: >-
          py.test
        env:
          DEBUG: 1
          MAIL_DEBUG_BODY: 1
          MAIL_ENABLED: False

  publish:
    name: Build and publish Python ðŸ distributions ðŸ“¦ to PyPI
    needs: ci
    if: startsWith(github.ref, 'refs/tags')
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@v6
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.x"
      - name: Install pypa/build
        run: >-
          python3 -m pip install build --user
      - name: Build a binary wheel
        run: >-
          python3 -m build
      - name: Publish distribution ðŸ“¦ to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

  matrix:
    name: >-
      Test with Python ${{ matrix.python-version }} / PG ${{ matrix.pg-version }} ðŸ
    needs: publish
    if: startsWith(github.ref, 'refs/tags')
    runs-on: ubuntu-latest
    env:
      INDEXER_KEY: testkey0123456789
      PGPASSWORD: mysecretpassword
    strategy:
      fail-fast: false
      matrix:
        include:
          # All Python versions with PG 18 (except 3.12 already tested)
          - python-version: "3.10"
            pg-version: "18"
          - python-version: "3.11"
            pg-version: "18"
          - python-version: "3.13"
            pg-version: "18"
          - python-version: "3.14"
            pg-version: "18"
          # All PG versions with Python 3.12 (except PG 18 already tested)
          - python-version: "3.12"
            pg-version: "12"
          - python-version: "3.12"
            pg-version: "14"
          - python-version: "3.12"
            pg-version: "15"
          - python-version: "3.12"
            pg-version: "16"
          - python-version: "3.12"
            pg-version: "17"
    services:
      postgres:
        image: "postgres:${{ matrix.pg-version }}"
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
        env:
          POSTGRES_PASSWORD: ${{ env.PGPASSWORD }}
      meilisearch:
        image: getmeili/meilisearch:v1.1
        ports:
          - 7700:7700
        env:
          MEILI_MASTER_KEY: ${{ env.INDEXER_KEY }}
    steps:
      - uses: actions/checkout@v6
      - name: Cache APT packages
        uses: actions/cache@v4
        id: apt-cache
        with:
          path: ~/apt-cache
          key: apt-ffmpeg-${{ runner.os }}
      - name: Install ffmpeg
        run: |
          if [ -d ~/apt-cache ] && ls ~/apt-cache/*.deb 1>/dev/null 2>&1; then
            sudo dpkg -i ~/apt-cache/*.deb 2>/dev/null || (sudo apt-get update -qq && sudo apt-get install -y -f --no-install-recommends)
          else
            sudo apt-get update -qq
            sudo apt-get install -y --no-install-recommends ffmpeg
            sudo apt-get autoclean -y
            mkdir -p ~/apt-cache
            cp /var/cache/apt/archives/ffmpeg*.deb ~/apt-cache/ 2>/dev/null || true
            cp /var/cache/apt/archives/libav*.deb ~/apt-cache/ 2>/dev/null || true
            cp /var/cache/apt/archives/libsw*.deb ~/apt-cache/ 2>/dev/null || true
            cp /var/cache/apt/archives/libpostproc*.deb ~/apt-cache/ 2>/dev/null || true
          fi
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
      - name: Upgrade pip ðŸ“¦
        run: >-
          pip install --upgrade pip setuptools
      - name: Install packages ðŸ“¦
        run: >-
          pip install -r requirements.txt
      - name: Create database ðŸ—„
        run: >-
          psql -c 'create database zoudb;' -U postgres -h 127.0.0.1
      - name: Run tests ðŸ§ª
        run: >-
          py.test
        env:
          DEBUG: 1
          MAIL_DEBUG_BODY: 1
          MAIL_ENABLED: False
